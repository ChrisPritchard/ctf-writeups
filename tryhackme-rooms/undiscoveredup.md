# Undiscovered

https://tryhackme.com/room/undiscoveredup

A medium-classified room, but one with a few twists and turns :) Took me a sleep and *almost* giving up before I got it, but there is nothing here but the basics so its a great room.

The room description suggested adding 'undiscovered.thm to your hosts', which is generally a hint subdomain enumeration is required.

1. Enumeration revealed four ports: 22, 80, 111 and 2049. The latter two were not resolved, but these are NFS ports meaning I eventually would be able to mount something remotely, presumably.
2. On 80 was a simple website with a message saying 'follow the darker path, or similar'. A quick whack at it with Nikto and gobuster showed nothing, so I moved onto subdomain enumeration.
3. To enumerate domains, I used ffuf with `ffuf -u undiscovered.thm -H "Host: FUZZ.undiscovered.thm" -w directory-list-2.3-medium.txt" -ac`. This immediately revealed a bunch of entries, which was a bit suspicious. Going to one at random I found 'RiteCMS' running. Exciting! There is a public exploit for this and its stated version here: https://www.exploit-db.com/exploits/48636 HOWEVER, I quickly discovered the page was just a stub. All its links went nowhere.
4. Thinking through, I reran ffuf with the cms sub directory stated in the exploit: `-u undiscovered.thm/cms/` (note the trailing slash) and found one of the sites was real, the others all fake :)
5. On that site, the default credentials didn't work, so I broke it with hydra: `hydra -l admin -P ./rockyou.txt <redacted> http-post-form "/cms/index.php:username=^USER^&userpw=^PASS^:login_failed"` which quickly got me the admin password.
6. The exploit for RiteCMS is straight-forward: via file manager you can upload anything, including straight, un-obfuscated PHP shells, so I did that and got a reverse shell as www-root.
7. On the box things were fairly locked down. There were two users, leonard and william, but no immediately obvious way to get to one of them from www-data. I ran linpeas.sh, and this revealed that (as mentioned earlier) a nfs mount was exposed: `/home/william *(rw,root_squash)`. I've compromised nfs before *with* root squash, but not normally, so this was a bit of a learning experience. Specifically, back on my host machine, running `mount -t nfs <ip>:/home/william /tmp/mnt` would work, but the folder would be owned by 'nobody', and be inacessible even to me as root!
8. A bit of research (and faffing about) revealed that if I created the same local user as on the remote system, I could access it. Specifically william with user id 1003: `useradd -u 1003 william && su william`. This got me into my mounted folder and the first flag.
9. Where from here? I had a bit of a brain fail, and slept on this, before the following morning immediately realising I can just create a .ssh folder with an authorized_keys file containing my public key, and then ssh in :)
10. As william, inside their directory was a write protected `admin.sh` and a `script` suid binary, running as leonard. The admin script did nothing, but was clearly being invoked by the script binary. I deleted admin.sh (as I own the folder I could do this) and created my own, however, even though this was invoked it was still only operating as william, not leonard.
11. Confused, I base64 encoded the script binary and copied/reversed to my host machine where I run ghidra (base64 is just easier for smaller files than scp'ing around) - after reversing, I could see that if the binary was run with no arguments it would run the script without suid, but if provided an argument it would perform `/bin/cat /home/leonard/<arg>` WITH leonard's permissions!
12. I thought this might be simple command injection, and CI worked in that `1;touch /tmp/test` worked but the file was still as william - potentially something to do with how `setreuid` works. Blindly I tried `.ssh/id_rsa` and surprise, surprise, got leonards private key :)
13. As leonard I got stuck for a bit. I ran linpeas again, but saw nothing. Careful enumeration revealed two things: there were lxd private keys under .config in leonards' folder, and leonard was part of the developer group who had access to `/usr/bin/vim.basic`, but this latter was not a SUID binary. I was stuck!
14. Eventually I ran linpeas *again* and read through it carefully. I finally spotted the key, which linpeas should really highlight more: vim.basic had the CAP_SETUID capability! Running it, then running `:py3 import os; os.setuid(0); os.execl("/bin/sh", "sh", "-c", "reset; exec sh")` (note the slight mod for python3: :py to :py3) and I had a root shell :)
15. The final 'flag' for this room was the root user's password hash from /etc/shadow. Nice :)
